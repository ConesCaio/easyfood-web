<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../shared-styles.html">

<dom-module id="food-menu">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }
      button {
        cursor: pointer;
        border-radius: 5px;
      }

      .button {
        width: 100px;
      }

      h1 {
        margin: 0;
      }

      hr {
        margin-top: 0;
      }

      .row {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
      }

      p {
        margin: 5px;
      }

      .input {
        margin: 5px;
        width: 100%;
      }

      .create-menu[disabled] {
        background: gray;

        cursor: default;
      }
    </style>

    <div class="card">
      <div class="row">
        <h1>Novo Cardápio</h1>
        <div>
          <button hidden$="[[!_isCreating]]"
            on-click="_createNewMenu"
            class="button create-menu"
            disabled$="[[!_abletoSave(_newMenu.name, _newMenu.categories.*)]]">
            <span>Salvar</span>
          </button>
          <button
            on-click="_changeIsEditing"
            class="button">
            <span hidden$="[[_isCreating]]">Criar</span><span  hidden$="[[!_isCreating]]">Cancelar</span>
          </button>
        </div>
      </div>
      <div hidden$="[[!_isCreating]]">
        <div style="padding: 15px;">
          <div class="row">
            <input
              id="menuNameInput"
              class="input"
              type="text"
              placeholder="Nome"
              value="{{_newMenu.name::input}}">
          </div>
          <h1>Categorias</h1>
          <hr>
          <div class="row">
            <input
            id="categoryInput"
            class="input"
            type="text"
            placeholder="Categoria"
            value="{{_newCategory.name::input}}">
            <button
              on-click="_createNewCategory"
              class="button">
              Adicionar Categoria
            </button>
          </div>
          <template is="dom-repeat" items="{{_newMenu.categories}}" as="category">
            <div style="border-radius: 5px; margin: 30px; box-shadow: 0 1px 1px; padding: 20px;">
              <b>[[category.name]]</b>
              <button
                  on-click="_removeCategory"
                  style="text-decoration: underline; background: none; color: var(--highlight-color)"
                  class="button">
                  remover
                </button>
                <div class="row">
                  <input
                    id="categoryInput"
                    class="input"
                    type="text"
                    placeholder="Nome"
                    value="{{category.newItem.name::input}}">
                  <input
                    id="categoryInput"
                    class="input"
                    type="text"
                    placeholder="Preço"
                    value="{{category.newItem.price::input}}">

                <button
                  on-click="_createNewItem"
                  class="button">
                  Adicionar Item
                </button>
                </div>
                <input
                style="width: 90%"
                  id="categoryInput"
                  class="input"
                  type="text"
                  placeholder="Descrição"
                  value="{{category.newItem.description::input}}">
                <template is="dom-repeat" items="{{category.items}}" as="dish">
                  <div style="margin: 30px">
                    <div class="row">
                      <b>[[dish.name]]</b>
                      <button
                        on-click="_removeItem"
                        style="text-decoration: underline; background: none; color: var(--highlight-color)"
                        class="button">
                        remover
                      </button> 
                    </div>
                    <p>[[dish.description]]</p>
                    <p>R$ [[dish.price]]</p>
                  </div>
                </template>
            </div>
          </template>
        </div>
      </div>

    </div>

    <template is="dom-repeat" items="{{menus}}" as="menu">
      <div class="card">
        <div class="row">
          <h1>[[menu.name]]</h1>
          <div>
            <button
              hidden$="[[menu.editing]]"
              on-click="_enableEdit"
              class="button">
              <span>Editar</span>
            </button>
            <button
              hidden$="[[!menu.editing]]"
              on-click="_cancelEdit"
              class="button">
              <span>Cancelar</span>
            </button>
            <button
              hidden$="[[!menu.editing]]"
              on-click="_saveEdit"
              class="button">
              <span>Salvar</span>
            </button>
            
            <button
              on-click="_changeMenuStatus"
              class="button">
              <span hidden$="[[menu.status]]">Ativar</span><span hidden$="[[!menu.status]]">Desativar</span>
            </button>
            <button
              hidden$="[[menu.editing]]"
              style="text-decoration: underline; background: none; color: var(--highlight-color)"
              on-click="_deleteMenu"
              class="button">
              <span>Apagar</span>
            </button>
          </div>
        </div>
        <p><b>Status: </b> <span hidden$="[[!menu.status]]" style="background: green; color: ghostwhite; border-radius: 5px; padding: 2px">Ativo</span><span hidden$="[[menu.status]]" style="background: firebrick; color: ghostwhite; border-radius: 5px;  padding: 3px">Inativo</span></p>

        <div style="padding: 15px;" hidden$="[[menu.editing]]">
          <template is="dom-repeat" items="{{menu.categories}}" as="category">
            <h1>[[category.name]]</h1>
            <hr>
            <template is="dom-repeat" items="{{category.items}}" as="dish">
              <div style="margin: 30px">
                <b>[[dish.name]]</b>
                <p>[[dish.description]]</p>
                <p>R$ [[dish.price]]</p>
              </div>
            </template>
          </template>
        </div>
        



        <div hidden$="[[!menu.editing]]">
          <h1>Categorias</h1>
            <hr>
            <div class="row">
              <input
              id="categoryInput"
              class="input"
              type="text"
              placeholder="Categoria"
              value="{{_currentlyEditing.newCategory.name::input}}">
              <button
                on-click="_EDITcreateNewCategory"
                class="button">
                Adicionar Categoria
              </button>
            </div>
            <template is="dom-repeat" items="{{_currentlyEditing.categories}}" as="category">
              <div style="border-radius: 5px; margin: 30px; box-shadow: 0 1px 1px; padding: 20px;">
                <b>[[category.name]]</b>
                <button
                  on-click="_EDITremoveCategory"
                  style="text-decoration: underline; background: none; color: var(--highlight-color)"
                  class="button">
                  remover
                </button>
                <div class="row">
                  <input
                    id="categoryInput"
                    class="input"
                    type="text"
                    placeholder="Nome"
                    value="{{category.newItem.name::input}}">
                  <input
                    id="categoryInput"
                    class="input"
                    type="text"
                    placeholder="Preço"
                    value="{{category.newItem.price::input}}">
  
                  <button
                    on-click="_EDITcreateNewItem"
                    class="button">
                    Adicionar Item
                  </button>
                </div>
                <input
                  style="width: 90%"
                  id="categoryInput"
                  class="input"
                  type="text"
                  placeholder="Descrição"
                  value="{{category.newItem.description::input}}">
                <template is="dom-repeat" items="{{category.items}}" as="dish">
                  <div style="margin: 30px">
                    <div class="row">
                      <b>[[dish.name]]</b>
                      <button
                        on-click="_EDITremoveItem"
                        style="text-decoration: underline; background: none; color: var(--highlight-color)"
                        class="button">
                        remover
                      </button> 
                    </div>
                    <p>[[dish.description]]</p>
                    <p>R$ [[dish.price]]</p>
                  </div>
                </template>
              </div>
            </template>
        </div>
      </div>
    </template>
  </template>

  <script>
    class FoodMenu extends Polymer.Element {
      static get is() { return 'food-menu'; }
      
      static get properties() {
        return {
          user: Object,
          page: String,
          menus: {
            type: Array,
            value: []
          },
          _fs: {
            type: Object,
            value: () => {
              return firebase.firestore();
            }
          },
          _isCreating: {
            type: Boolean,
            value: false
          },
          _isEditing: {
            type: Boolean,
            value: false
          },
          _availableCategories: {
            type: Array,
            value: ['Entrada', 'Prato Principal', 'Sobremesa', 'Bebida']
          },
          _newMenu: {
            type: Object,
            value: {
              name: '',
              categories: []
            }
          },
          _newCategory: {
            type: Object,
            value: {
              name: '',
              items: [],
            }
          },
          _newItem: {
            type: Object,
            value: {
              name: '',
              price: '',
              description: ''
            }
          },
          _currentlyEnabledMenu: {
            type: Object,
          },
          _currentlyEditing: {
            type: Object
          }
        };
      }

      static get observers() {
        return ['_onPageChanged(page, user)'];
      }

      _createNewCategory() {
        if(this._newCategory.name) {
          this.push('_newMenu.categories', {
            name: this._newCategory.name,
            items: [],
            newItem: {}
          });
          this._newCategory = {};
        }
      }

      _EDITcreateNewCategory() {
        if(this._currentlyEditing.newCategory.name) {
          this.push('_currentlyEditing.categories', {
            name: this._currentlyEditing.newCategory.name,
            items: [],
            newItem: {}
          });
          this._currentlyEditing.toAdd = this._currentlyEditing.toAdd || [];

          this._currentlyEditing.toAdd.push({
            name: this._currentlyEditing.newCategory.name
          });
          this.set('_currentlyEditing.newCategory', {});
        }
      }

      _removeCategory(e) {
        this.splice('_newMenu.categories', this._newMenu.categories.indexOf(e.model.category), 1);
      }

      _EDITremoveCategory(e) {
        if (this._currentlyEditing.toAdd && this._currentlyEditing.toAdd.indexOf(e.model.category)) {
          this.splice('_currentlyEditing.toAdd', this._currentlyEditing.toAdd.indexOf(e.model.category), 1);
        } else {
          this._currentlyEditing.toRemove = this._currentlyEditing.toRemove || [];
          this._currentlyEditing.toRemove.push(e.model.category);
        }
        this.splice('_currentlyEditing.categories', this._currentlyEditing.categories.indexOf(e.model.category), 1);
      }

      _createNewItem(e) {
        if(e.model.category.newItem.name && e.model.category.newItem.price && e.model.category.newItem.description) {
          e.model.push('category.items', {
            name: e.model.category.newItem.name,
            price: parseFloat(e.model.category.newItem.price),
            description: e.model.category.newItem.description
          });
          e.model.set('category.newItem', {});
        }
      }

      _EDITcreateNewItem(e) {
        if(e.model.category.newItem.name && e.model.category.newItem.price && e.model.category.newItem.description) {
          e.model.push('category.items', {
            name: e.model.category.newItem.name,
            price: parseFloat(e.model.category.newItem.price),
            description: e.model.category.newItem.description
          });

          const categoryIndex = this._currentlyEditing.categories.findIndex(category => category.name === e.model.category.name);
          this._currentlyEditing.categories[categoryIndex].toAdd = this._currentlyEditing.categories[categoryIndex].toAdd || [];
          this._currentlyEditing.categories[categoryIndex].toAdd.push({
            name: e.model.category.newItem.name,
            price: parseFloat(e.model.category.newItem.price),
            description: e.model.category.newItem.description
          });
          e.model.set('category.newItem', {});
        }
      }

      _removeItem(e) {
        const categoryIndex = this._newMenu.categories.findIndex(category => category.name === e.model.parentModel.category.name);
        this.splice(`_newMenu.categories.${categoryIndex}.items`, e.model.index, 1);
      }

      _EDITremoveItem(e) {
        const categoryIndex = this._currentlyEditing.categories.findIndex(category => category.name === e.model.parentModel.category.name);
        if (this._currentlyEditing.categories[categoryIndex].toAdd && this._currentlyEditing.categories[categoryIndex].toAdd.find(item => item.name === e.model.dish.name)) {
          this.splice(`_currentlyEditing.categories.${categoryIndex}.toAdd`, this._currentlyEditing.categories[categoryIndex].toAdd.findIndex(item => item.name === e.model.dish.name), 1);
        } else {
          this._currentlyEditing.categories[categoryIndex].toRemove = this._currentlyEditing.categories[categoryIndex].toRemove || [];
          this._currentlyEditing.categories[categoryIndex].toRemove.push(this._currentlyEditing.categories[categoryIndex].items[e.model.index]);
        }
        this.splice(`_currentlyEditing.categories.${categoryIndex}.items`, e.model.index, 1);
      }

      _changeIsEditing() {
        this._resetEdit();
      }

      _resetEdit() {
        this._newCategory = { name: ''};
        this._newItem = {
          name: '',
          price: '',
          description: ''
        }
        this._newMenu = {
          name: '',
          categories: []
        }
        this._isCreating = !this._isCreating;
      }

      _onPageChanged(page, user) {
        if(page == 'food-menu' && user) {
          this._fetchData();
        } else {
          this.set('menus', []);
        }
      }

      _fetchData() {
        this._getMenus()
          .then( menus => this._extractMenus(menus))
          .then( menus => this._getCategories(menus))
          .then( results => {
            let menus = results[0];
            let menusCategories = results[1];
            
            menus.forEach( (menu, index) => {
              menu.categories = menusCategories[index];
              menu.editing = false;
              if (menu.status) this.set('_currentlyEnabledMenu', menu);
            })
            this.set('menus', menus.filter(menu => { return menu.categories.length; }));
          })
      }

      _getMenus() {
        return this._fs
          .collection("restaurants").doc(this.user.email).collection("menu")
          .get();
      }

      _extractMenus(querySnapshot) {
        let menus = [];
        querySnapshot.forEach( doc => {
          let menu = doc.data();
          menu.id = doc.id;
          menus.push(menu);
        });
        return menus;
      }

      _getCategories(menus) {
        let categoriesPromises = [];
        menus.forEach( menu => categoriesPromises.push(this._getCategoryCollection(menu)));
        return Promise.all([menus, Promise.all(categoriesPromises)]);
      }

      _getCategoryCollection(menu) {
        return this._fs.collection("restaurants").doc(this.user.email).collection("menu").doc(menu.id).collection("category")
          .get()
            .then(querySnapshot => {
              let categories = [];
              querySnapshot.forEach( doc => {
                let category = doc.data();
                category.id = doc.id;
                categories.push(category);
              })
              return categories;
            })
            .then(categories => {
              let itemsPromises = [];
              categories.forEach( category => itemsPromises.push(this._getItemCollection(menu, category)));
              return Promise.all([categories, Promise.all(itemsPromises)]);
            })
            .then(results => {
              let categories = results[0];
              let categoriesItems = results[1];
             
              categories.forEach( (category, index) => {
                category.items = categoriesItems[index];
              })

              return categories;
            })
      }
      _getItemCollection(menu, category) {
        return this._fs.collection("restaurants").doc(this.user.email).collection("menu").doc(menu.id).collection("category").doc(category.id).collection("menuItem")
          .get()
            .then(querySnapshot => {
              let items = [];
              querySnapshot.forEach( doc => {
                let item = doc.data();
                item.id = doc.id;
                items.push(item);
              });
              return items;
            })
      }

      _changeMenuStatus(e) {
        if (!this._currentlyEnabledMenu) {
          this._fs.collection("restaurants").doc(this.user.email).collection("menu").doc(e.model.menu.id).update({
            status: true
          })
          .then(() => {
            e.model.set('menu.status', true);
            this.set('_currentlyEnabledMenu', e.model.menu);
          })
          .catch(error => {
            console.error(error);
          });
        
        } else {
          if (e.model.menu.status) {
            this._fs.collection("restaurants").doc(this.user.email).collection("menu").doc(e.model.menu.id).update({
              status: false
            })
            .then(() => {
              e.model.set('menu.status', false);
              this.set('_currentlyEnabledMenu', null);
            })
            .catch(error => {
              console.error(error);
            });
          } else {
            let previousActive = this._fs.collection("restaurants").doc(this.user.email).collection("menu").doc(this._currentlyEnabledMenu.id).update({
              status: false
            })
            .then(() => {
              this.set('_currentlyEnabledMenu.status', false);
              this.notifyPath(`menus.${this.menus.indexOf(this._currentlyEnabledMenu)}.status`);
            })
            .catch(error => {
              console.error(error);
            });
            let newActive = this._fs.collection("restaurants").doc(this.user.email).collection("menu").doc(e.model.menu.id).update({
              status: true
            })
            .then(() => {
              e.model.set('menu.status', true);
              this.set('_currentlyEnabledMenu', e.model.menu);
            })
            .catch(error => {
              console.error(error);
            });

            Promise.all([previousActive, newActive]);
          }
        }
      }

      _abletoSave() {
        return this._newMenu.name.length && this._newMenu.categories.length && this._newMenu.categories[0].items.length;
      }

      _createNewMenu() {
        this._fs.collection("restaurants").doc(this.user.email).collection("menu").add({
          name: this._newMenu.name,
          status: false
        })
        .then(newMenu => {
          this._newMenu.id = newMenu.id;
          let categories = this._newMenu.categories.map(category => {
            return this._fs.collection("restaurants").doc(this.user.email).collection("menu").doc(newMenu.id).collection("category").add({
              name: category.name
            });
          })

          return Promise.all(categories);
        })
        .then(results => {
          let items = this._newMenu.categories
            .flatMap( (category, index) => category.items
              .map(item => this._fs
                .collection("restaurants").doc(this.user.email)
                .collection("menu").doc(this._newMenu.id)
                .collection("category").doc(results[index].id)
                .collection("menuItem").add({
                  name: item.name,
                  price: item.price,
                  description: item.description
                })
              )
            )
          
          return Promise.all(items)
        })
        .then(results => {
          this._fetchData();
          this._resetEdit();
        });
      }

      _deleteMenu(e) {
        this._fs.collection("restaurants").doc(this.user.email).collection("menu").doc(e.model.menu.id).delete()
          .then(() => {
            this._fetchData();
          })
      }

      _enableEdit(e) {
        e.model.set('menu.editing', !e.model.menu.editing);

        this.set('_currentlyEditing', JSON.parse(JSON.stringify(e.model.menu)));
        this._currentlyEditing.newCategory = {};
        this._currentlyEditing.categories.forEach(category => { category.newItem = {};})
      }

      _cancelEdit(e) {
        this._fetchData();
      }

      _saveEdit(e) {
        const categoriesToAdd = (this._currentlyEditing.toAdd || []);
        const categoriesToRemove = (this._currentlyEditing.toRemove || []);

        let updates = [];

        categoriesToAdd.forEach(category => {
          updates.push(this._fs.collection("restaurants").doc(this.user.email).collection("menu").doc(this._currentlyEditing.id).collection("category").add({
            name: category.name,
            status: false
          }))
        })

        categoriesToRemove.forEach(category => {
          updates.push(this._fs.collection("restaurants").doc(this.user.email).collection("menu").doc(this._currentlyEditing.id).collection("category").doc(category.id).delete());
        })

        this._currentlyEditing.categories.forEach(category => {
          const itemsToAdd = category.toAdd || [];
          const itemsToRemove = category.toRemove || [];
          itemsToAdd.forEach(item => {
            updates.push(this._fs.collection("restaurants").doc(this.user.email).collection("menu").doc(this._currentlyEditing.id).collection("category").doc(category.id).collection("menuItem").add({
              name: item.name,
              price: item.price,
              description: item.description
            }))
          })
          itemsToRemove.forEach(item => {
            updates.push(this._fs.collection("restaurants").doc(this.user.email).collection("menu").doc(this._currentlyEditing.id).collection("category").doc(category.id).collection("menuItem").doc(item.id).delete());
          })
        })
          
          Promise.all(updates)
          .then(results => {
            this._fetchData();
            this.set('_currentlyEditing');
            this.set('_isEditing', false);
            e.model.set('menu.editing', false);
          });
      }
    }

    window.customElements.define(FoodMenu.is, FoodMenu);
  </script>
</dom-module>
